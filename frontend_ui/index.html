<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–µ–ª—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 2rem;
            background-color: #f9f9f9;
        }
        .hidden {
            display: none;
        }
        .card {
            width: 70%;
            max-width: 1200px;
            margin: auto;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
        }
        .card-small {
            width: 50%;
            max-width: 800px;
            margin: auto;
            box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
        }
        h3 {
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div id="loginSection" class="card-small p-4 mb-4">
        <h3 class="mb-3">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <div class="mb-3">
            <input type="text" id="apiKey" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á">
        </div>
        <button class="btn btn-primary w-100" onclick="authorize()">–í–æ–π—Ç–∏</button>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
    <div id="mainSection" class="card p-4 hidden">
        <h3 class="mb-4">–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ c–ø—Ä–æ—Å–∞</h3>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
        <div class="mb-3">
            <label for="csvFile" class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (CSV):</label>
            <input class="form-control" type="file" id="csvFile" accept=".csv">
<!--            <input class="form-control" type="file" id="csvFile">-->
        </div>
        <button class="btn btn-outline-primary w-100 mb-3" onclick="uploadCSV()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
        <div class="mb-3">
            <label for="forecastDate" class="form-label">–î–∞—Ç–∞, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≥–Ω–æ–∑:</label>
            <input type="date" id="forecastDate" class="form-control" max="">
        </div>
        <div class="mb-3">
            <label class="form-label">–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞:</label>
            <select id="horizon" class="form-select">
                 <option value="30">1‚Äì30 –¥–Ω–µ–π</option>
                <option value="7">1‚Äì7 –¥–Ω–µ–π</option>
                <option value="0">–¢–æ–ª—å–∫–æ –∏—Å—Ç–æ—Ä–∏—è</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">–ù–∞–ª–∏—á–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞:</label>
            <select id="deposit" class="form-select">
                <option value="false">–ù–µ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞</option>
                <option value="true">–ï—Å—Ç—å –¥–µ–ø–æ–∑–∏—Ç</option>
            </select>
        </div>

        <button class="btn btn-primary w-100 mb-3" onclick="fetchForecast()">–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</button>

        <!-- –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ -->
        <div class="mb-3">
            <label class="form-label">–§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
            <select id="displayMode" class="form-select">
                <option value="chart">–ì—Ä–∞—Ñ–∏–∫</option>
                <option value="table">–¢–∞–±–ª–∏—Ü–∞</option>
            </select>
        </div>

        <button class="btn btn-primary w-100 mb-4" onclick="renderForecast()">–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å</button>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="forecastOutput" class="hidden">
            <div id="forecastWarning" class="alert alert-warning hidden" role="alert"></div>
            <div id="forecastTable" class="hidden"></div>
            <canvas id="forecastChart" class="hidden"></canvas>
            <div id="historySummary" class="mt-3"></div>
        </div>
    </div>
</div>

<!-- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.onload = function () {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById("forecastDate");
        dateInput.value = today;
        dateInput.max = today;
    };


    async function authorize() {
        const key = document.getElementById("apiKey").value.trim();
        if (!key) {
            alert("–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á.");
            return;
        }

        try {
            const response = await fetch("http://localhost:8001/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ api_key: key }),
            });

            const result = await response.json().catch(() => ({}));

            if (!response.ok) {
                // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ ServiceError
                if (result.error && result.error.type) {
                    const { type, message } = result.error;
                    switch (type) {
                        case "AuthorizationError":
                            alert("üîí –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + message);
                            break;
                        case "ExternalServiceError":
                            alert("üåê –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: " + message);
                            break;
                        default:
                            alert(`‚ùî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ (${type}): ${message}`);
                    }
                } else {
                    alert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.");
                }
                return;
            }

            // ‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            const token = result.access_token;
            if (!token) {
                alert("‚ö†Ô∏è –û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –ø–æ–ª—É—á–µ–Ω.");
                return;
            }

            localStorage.setItem("access_token", token);

            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("mainSection").classList.remove("hidden");

            alert("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
        } catch (err) {
            alert("üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: " + err.message);
            console.error(err);
        }
    }


    async function fetchForecast() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.");
            return;
        }

        const target_date = document.getElementById('forecastDate').value;
        const has_deposit = document.getElementById('deposit').value === 'true';

        const horizonValue = document.getElementById('horizon').value;
        const isHistoryOnly = horizonValue === 'history';
        const horizon = isHistoryOnly ? 0 : parseInt(horizonValue);

        const warningDiv = document.getElementById('forecastWarning');
        const forecastOutput = document.getElementById('forecastOutput');

        warningDiv.classList.add('hidden');
        warningDiv.textContent = '';
        forecastOutput.classList.add('hidden');

        try {
            const response = await fetch("http://localhost:8001/fetch-forecast", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
               body: JSON.stringify({
                   target_date,
                   horizon,
                   has_deposit,
                   history_window: 30
               })
            });

            const result = await response.json();

            // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            if (response.ok && result.hotel_id !== undefined) {
                window.forecastData = result.forecast;
                window.historyData = result.history_summary;

                forecastOutput.classList.remove("hidden");
                renderForecast();
                return;
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö –æ—à–∏–±–æ–∫ ServiceError
            if (result.error && result.error.type) {
                const { type, message } = result.error;

                switch (type) {
                    case "AuthorizationError":
                        alert(`üîí –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${message}`);
                        break;
                    case "NoForecastError":
                        warningDiv.textContent = "üì≠ –ü—Ä–æ–≥–Ω–æ–∑ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.";
                        break;
                    case "InsufficientHistoryError":
                        warningDiv.textContent = "‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.";
                        break;
                    case "DatabaseError":
                        warningDiv.textContent = "üíæ –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞.";
                        break;
                    case "ExternalServiceError":
                        warningDiv.textContent = "üåê –û—à–∏–±–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è.";
                        break;
                    default:
                        warningDiv.textContent = `‚ùî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ (${type}): ${message}`;
                }

                warningDiv.classList.remove("hidden");
                forecastOutput.classList.remove("hidden");
                return;
            }

            // === –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç ===
            warningDiv.textContent = "‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + JSON.stringify(result);
            warningDiv.classList.remove("hidden");
            forecastOutput.classList.remove("hidden");

        } catch (err) {
            warningDiv.textContent = "üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: " + err.message;
            warningDiv.classList.remove("hidden");
            forecastOutput.classList.remove("hidden");
            console.error(err);
        }
    }


    async function uploadCSV() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("üîë –í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
            return;
        }

        const fileInput = document.getElementById("csvFile");
        const file = fileInput?.files?.[0];

        if (!file) {
            alert("üìÇ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV-—Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);

        try {
            const response = await fetch("http://localhost:8001/import-bookings", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`
                },
                body: formData
            });

            const result = await response.json().catch(() => ({}));

            // === –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ===
            if (response.ok && result.hotel_id !== undefined) {
                const added = result.added ?? 0;
                const skipped = result.duplicates_skipped ?? 0;
                alert(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${added} –∑–∞–ø–∏—Å–µ–π. –ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: ${skipped}.`);
                return;
            }

            // === –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –æ—à–∏–±–∫–∞ –∏–∑ ServiceError ===
            if (result.error && result.error.type) {
                const { type, message } = result.error;

                switch (type) {
                    case "AuthorizationError":
                        alert(`üîí –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${message}`);
                        break;
                    case "CSVProcessingError":
                        alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV: ${message}`);
                        break;
                    case "MappingError":
                        alert(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö: ${message}`);
                        break;
                    case "ConflictError":
                        alert(`‚ÑπÔ∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç –¥–∞–Ω–Ω—ã—Ö: ${message}`);
                        break;
                    case "DatabaseError":
                        alert(`üíæ –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${message}`);
                        break;
                    case "ExternalServiceError":
                        alert(`üåê –û—à–∏–±–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞: ${message}`);
                        break;
                    default:
                        alert(`‚ùî –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ (${type}): ${message}`);
                }
                return;
            }

            // === –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç ===
            alert("‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + JSON.stringify(result));

        } catch (error) {
            alert("üö´ –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: " + error.message);
        }
    }


    function renderForecast() {
        const mode = document.getElementById('displayMode').value;
        const chartCanvas = document.getElementById('forecastChart');
        const tableContainer = document.getElementById('forecastTable');

        chartCanvas.classList.add('hidden');
        tableContainer.classList.add('hidden');

        if (!window.forecastData || !window.historyData) {
            alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
            return;
        }

        if (mode === 'chart') {
            renderForecastChart();
        } else {
            renderForecastTable();
        }
    }


    function renderForecastChart() {
        const chartCanvas = document.getElementById('forecastChart');
        const ctx = chartCanvas.getContext('2d');

        const history = window.historyData;
        const forecast = window.forecastData;

        const combined = [...history.map(d => ({...d, type: '–ò—Å—Ç–æ—Ä–∏—è'})), ...forecast.map(d => ({...d, type: '–ü—Ä–æ–≥–Ω–æ–∑'}))];

        const labels = combined.map(d => d.date);
        const bookings = combined.map(d => d.bookings);
        const cancellations = combined.map(d => d.cancellations);
        const adjustedDemand = combined.map(d => d.bookings - d.cancellations);

        const horizonValue = document.getElementById('horizon').value;
        const isHistoryOnly = horizonValue === "0";

        const backgroundBookings = combined.map(d => {
            if (isHistoryOnly) return 'rgba(65,134,243, 0.6)';
            return d.type === '–ò—Å—Ç–æ—Ä–∏—è' ? 'rgba(65,134,243,0.2)' : 'rgba(65,134,243,0.6)';
        });

        const backgroundCancellations = combined.map(d => {
            if (isHistoryOnly) return 'rgba(255, 99, 132, 0.6)';
            return d.type === '–ò—Å—Ç–æ—Ä–∏—è' ? 'rgba(255, 99, 132, 0.2)' : 'rgba(255, 99, 132, 0.6)';
        });

        if (window.chartInstance) {
            window.chartInstance.destroy();
        }

        window.chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è',
                        data: bookings,
                        backgroundColor: backgroundBookings,
                        stack: 'stack1'
                    },
                    {
                        label: '–û—Ç–º–µ–Ω—ã',
                        data: cancellations,
                        backgroundColor: backgroundCancellations,
                        stack: 'stack1'
                    },
                    {
                        label: '–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø—Ä–æ—Å',
                        data: adjustedDemand,
                        type: 'line',
                        borderColor: 'black',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.2,
                        fill: false,
                        order: 99
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });

        chartCanvas.classList.remove('hidden');
    }


    function renderForecastTable() {
        const tableContainer = document.getElementById('forecastTable');
        const history = window.historyData;
        const forecast = window.forecastData;

        const combined = [...history.map(d => ({...d, type: '–ò—Å—Ç–æ—Ä–∏—è'})), ...forecast.map(d => ({...d, type: '–ü—Ä–æ–≥–Ω–æ–∑'}))];

        const rows = combined.map(d => {
            const net = d.bookings - d.cancellations;
            return `<tr>
                <td>${d.date}</td>
                <td>${d.type}</td>
                <td>${d.bookings}</td>
                <td>${d.cancellations}</td>
                <td>${net}</td>
            </tr>`;
        }).join('');

        tableContainer.innerHTML = `
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                        <th>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</th>
                        <th>–û—Ç–º–µ–Ω—ã</th>
                        <th>–°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø—Ä–æ—Å</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
            </table>
        `;

        tableContainer.classList.remove('hidden');
    }
</script>
</body>
</html>